<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      background-color: #f7f9fc; 
    }
    .table-responsive { 
      margin-top: 20px; 
    }
    /* Force columns to respect percentages */
    .table {
      table-layout: fixed; /* Key for colgroup widths */
      width: 100%;
    }
    .feedback-input {
      width: 100%;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Changed container to container-fluid for full width -->
  <div class="container-fluid my-4">
    <h1 class="mb-4 text-center">Order Dashboard</h1>
    <div class="mb-3 text-center">
      Logged in as: <strong><%= role %></strong> | <a href="/login">Logout</a>
    </div>

    <!-- Summary Section -->
    <%
      // Filter for unfulfilled orders
      const unfulfilledOrders = orders.filter(order => order.fulfillment_status !== 'fulfilled');

      // Build a language-wise count of unfulfilled orders
      const languageCounts = {};
      unfulfilledOrders.forEach(order => {
        // Default language if none is found
        let foundLanguage = 'Unknown';

        // Check each line item for a property that includes 'language'
        order.line_items.forEach(item => {
          if (item.properties) {
            item.properties.forEach(prop => {
              if (prop.name && prop.name.toLowerCase().includes('language')) {
                foundLanguage = prop.value || 'Unknown';
              }
            });
          }
        });

        // Increment the count for this language
        if (!languageCounts[foundLanguage]) {
          languageCounts[foundLanguage] = 0;
        }
        languageCounts[foundLanguage]++;
      });
    %>

    <!-- Display the totals -->
    <div class="row mb-4">
      <div class="col-md-6">
        <h4>Total Unfulfilled Orders: <%= unfulfilledOrders.length %></h4>
      </div>
      <div class="col-md-6">
        <h4>Language-wise Unfulfilled Orders:</h4>
        <ul>
          <% for (let lang in languageCounts) { %>
            <li><strong><%= lang %></strong>: <%= languageCounts[lang] %></li>
          <% } %>
        </ul>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <!-- Define fixed column widths here -->
        <colgroup>
          <col style="width:7%;">
          <col style="width:10%;">
          <col style="width:55%;">
          <col style="width:6%;">
          <col style="width:22%;">
          <col style="width:5%;"> <!-- Column for Done checkbox -->
        </colgroup>

        <thead class="table-dark">
          <tr>
            <th>Order Number</th>
            <th>Customer Info</th>
            <th>Order Details</th>
            <th>Expected Delivery</th>
            <th>Feedback/Changes</th>
            <th>Done</th>
          </tr>
        </thead>
        <tbody>
          <% 
            // Helper functions for expected delivery calculation
            function getDeliveryHours(order) {
              var timelines = [
                { name: "Basic", ids: ["41290369269835"], hours: 240 },
                { name: "Standard", ids: ["41290369302603", "41274164510795"], hours: 120 },
                { name: "Premium", ids: ["41290369335371"], hours: 30 },
                { name: "Beast", ids: ["41290369368139"], hours: 30 },
                { name: "FAST", ids: ["41274164543563"], hours: 48 },
                { name: "EXPRESS", ids: ["41274164576331"], hours: 24 }
              ];
              var matchedHours = [];
              order.line_items.forEach(function(item) {
                var variantId = String(item.variant_id);
                timelines.forEach(function(timeline) {
                  if (timeline.ids.indexOf(variantId) !== -1) {
                    matchedHours.push(timeline.hours);
                  }
                });
              });
              if (matchedHours.length > 0) {
                return Math.min.apply(null, matchedHours);
              }
              return 240; // default: Basic plan (10 days)
            }

            function getExpectedDelivery(order) {
              var createdAt = new Date(order.created_at);
              var hours = getDeliveryHours(order);
              var deliveryTimestamp = createdAt.getTime() + hours * 60 * 60 * 1000;
              return new Date(deliveryTimestamp).toLocaleDateString("en-IN", {
                timeZone: "Asia/Kolkata",
                year: "numeric",
                month: "short",
                day: "numeric"
              });
            }
          %>

          <% orders.forEach(function(order) { %>
            <tr>
              <!-- Order Number -->
              <td><%= order.name %></td>

              <!-- Customer Info -->
              <td>
                <% if (order.customer) { %>
                  <%= order.customer.first_name %> <%= order.customer.last_name %><br>
                  <small><%= order.customer.phone %></small>
                <% } else { %>
                  Guest
                <% } %>
              </td>

              <!-- Order Details with Copy Button -->
              <td>
                <div class="order-details-container" id="order-details-<%= order.id %>">
                  <% order.line_items.forEach(function(item) { %>
                    <div>
                      <strong><%= item.title %></strong> &times; <%= item.quantity %><br>
                      <% if (item.properties && item.properties.length > 0) { %>
                        <% item.properties.forEach(function(prop) { 
                            var propName = prop.name.toLowerCase();
                            var displayValue = prop.value;
                            var shouldHide = false;

                            // For properties from "Form Data", filter confidential info for viewers
                            if (propName.includes('form data')) {
                              if (role === 'viewer') {
                                var lines = displayValue.split('\n');
                                lines = lines.filter(function(line) {
                                  var lowerLine = line.toLowerCase();
                                  if (
                                    lowerLine.includes('whatsapp') ||
                                    lowerLine.includes('price') ||
                                    lowerLine.includes('song type') ||
                                    lowerLine.includes('uploaded images') ||
                                    lowerLine.includes('selected addons')
                                  ) {
                                    return false;
                                  }
                                  return true;
                                });
                                displayValue = lines.join('\n');
                              }
                            } else {
                              if (role === 'viewer') {
                                if (
                                  propName.includes('whatsapp') ||
                                  propName.includes('price') ||
                                  propName.includes('song type') ||
                                  propName.includes('uploaded images') ||
                                  propName.includes('selected addons')
                                ) {
                                  shouldHide = true;
                                }
                              }
                            }
                        %>
                          <% if (!shouldHide) { %>
                            <small><%= prop.name %>: <%= displayValue %></small><br>
                          <% } %>
                        <% }); %>
                      <% } %>
                    </div>
                    <hr class="my-1">
                  <% }); %>
                </div>
                <button class="btn btn-sm btn-secondary mt-1 copy-btn" data-order-id="<%= order.id %>">Copy</button>
              </td>

              <!-- Expected Delivery -->
              <td>
                <%= getExpectedDelivery(order) %>
              </td>

              <!-- Feedback/Changes -->
              <td>
                <% if (role === 'admin') { %>
                  <input type="text" value="<%= order.note || '' %>" data-order-id="<%= order.id %>" class="feedback-field form-control">
                <% } else { %>
                  <%= order.note || 'N/A' %>
                <% } %>
              </td>

              <!-- Done Checkbox -->
              <td class="text-center">
                <input type="checkbox" name="done" data-order-id="<%= order.id %>">
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // For admin users, enable real-time feedback updates on blur.
    if ("<%= role %>" === "admin") {
      document.querySelectorAll('.feedback-field').forEach(function(field) {
        field.addEventListener('blur', function() {
          var orderId = this.getAttribute('data-order-id');
          var feedback = this.value;
          fetch('/update-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: orderId, feedback: feedback })
          })
          .then(response => response.json())
          .then(data => console.log("Feedback saved:", data))
          .catch(err => console.error("Error saving feedback:", err));
        });
      });
    }

    // Add event listeners for all copy buttons
    document.querySelectorAll('.copy-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        var orderId = this.getAttribute('data-order-id');
        var detailsElement = document.getElementById('order-details-' + orderId);
        if (detailsElement) {
          var textToCopy = detailsElement.innerText;
          navigator.clipboard.writeText(textToCopy).then(function() {
            alert('Order details copied to clipboard!');
          }).catch(function(err) {
            alert('Failed to copy text: ' + err);
          });
        }
      });
    });
  </script>
</body>
</html>
