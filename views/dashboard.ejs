<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4">Order Dashboard</h1>
    <div class="mb-3">
      Logged in as: <strong><%= role %></strong> | <a href="/login">Logout</a>
    </div>
    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>Order Number</th>
          <th>Customer Info</th>
          <th>Order Details</th>
          <th>Expected Delivery</th>
          <th>Feedback/Changes</th>
        </tr>
      </thead>
      <tbody>
        <% orders.forEach(order => { %>
          <tr>
            <!-- Use order.name to display the Shopify order number (e.g., "#1001") -->
            <td><%= order.name %></td>
            <td>
              <% if (order.customer) { %>
                <%= order.customer.first_name %> <%= order.customer.last_name %><br>
                <small><%= order.customer.phone %></small>
              <% } else { %>
                Guest
              <% } %>
            </td>
            <td>
              <% order.line_items.forEach(item => { %>
                <div>
                  <!-- Always display the item title -->
                  <strong><%= item.title %></strong><br>
                  
                  <% if (item.properties && item.properties.length > 0) { %>
                    <% item.properties.forEach(prop => { 
                         const propName = prop.name.toLowerCase();
                         let displayValue = prop.value;
                         let shouldHide = false;
                         
                         // If this property is a "Form Data" block, parse it.
                         if (propName.includes('form data')) {
                           if (role === 'viewer') {
                             // Split the text into individual lines.
                             let lines = displayValue.split('\n');
                             // Filter out confidential lines.
                             lines = lines.filter(line => {
                               const lowerLine = line.toLowerCase();
                               if (
                                 lowerLine.includes('whatsapp') ||
                                 lowerLine.includes('price') ||
                                 lowerLine.includes('song type') ||
                                 lowerLine.includes('uploaded images') ||
                                 lowerLine.includes('selected addons')
                               ) {
                                 return false;
                               }
                               return true;
                             });
                             displayValue = lines.join('\n');
                           }
                         } else {
                           // For properties that are not "Form Data", hide them entirely if they are confidential.
                           if (role === 'viewer') {
                             if (
                               propName.includes('whatsapp') ||
                               propName.includes('price') ||
                               propName.includes('song type') ||
                               propName.includes('uploaded images') ||
                               propName.includes('selected addons')
                             ) {
                               shouldHide = true;
                             }
                           }
                         }
                    %>
                      <% if (!shouldHide) { %>
                        <small><%= prop.name %>: <%= displayValue %></small><br>
                      <% } %>
                    <% }); %>
                  <% } %>
                </div>
                <hr class="my-1">
              <% }); %>
            </td>
            <td>
              <% 
                let deliveryDate = new Date(order.created_at);
                // Example logic: if order has tag "Basic", add 10 days; if "Premium", add 5 days.
                if (order.tags && order.tags.includes('Basic')) {
                  deliveryDate.setDate(deliveryDate.getDate() + 10);
                } else if (order.tags && order.tags.includes('Premium')) {
                  deliveryDate.setDate(deliveryDate.getDate() + 5);
                }
              %>
              <%= deliveryDate.toDateString() %>
            </td>
            <td>
              <% if (role === 'admin') { %>
                <input type="text" value="<%= order.note || '' %>" data-order-id="<%= order.id %>" class="feedback-field form-control">
              <% } else { %>
                <input type="text" value="<%= order.note || '' %>" class="form-control" readonly>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
  
  <script>
    // For admins, enable feedback update on blur event.
    if ("<%= role %>" === "admin") {
      document.querySelectorAll('.feedback-field').forEach(field => {
        field.addEventListener('blur', function() {
          const orderId = this.getAttribute('data-order-id');
          const feedback = this.value;
          fetch('/update-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId, feedback })
          })
          .then(response => response.json())
          .then(data => console.log("Feedback saved:", data))
          .catch(err => console.error("Error saving feedback:", err));
        });
      });
    }
  </script>
</body>
</html>
