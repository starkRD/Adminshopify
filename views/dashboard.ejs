<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f7f9fc;
    }
    /* Use a fixed layout so columns share available width */
    .table {
      table-layout: fixed;
      width: 100%;
    }
    /* Prevent header text from wrapping */
    .table thead th {
      white-space: nowrap;
    }
    /* Wrap cell content if too long */
    .table td {
      white-space: pre-wrap;
      word-break: break-word;
    }
    /* Reduce padding and font size on smaller screens */
    @media (max-width: 768px) {
      .table th, .table td {
        padding: 0.5rem;
        font-size: 0.85rem;
      }
    }
    /* Optional: force some columns to have a min-width */
    .col-order { min-width: 90px; }
    .col-customer { min-width: 130px; }
    .col-details { min-width: 150px; }
    .col-delivery { min-width: 110px; }
    .col-feedback { min-width: 120px; }
    .col-comments { min-width: 110px; }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h1 class="mb-4 text-center">Order Dashboard</h1>
    <div class="mb-3 text-center">
      Logged in as: <strong><%= role %></strong> | <a href="/login">Logout</a>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle table-sm">
        <thead class="table-dark">
          <tr>
            <th class="col-order">Order #</th>
            <th class="col-customer">Customer Info</th>
            <th class="col-details">Order Details</th>
            <th class="col-delivery">Expected Delivery</th>
            <th class="col-feedback">Feedback/Changes</th>
            <th class="col-comments">Comments</th>
          </tr>
        </thead>
        <tbody>
          <% 
            // Helper functions for expected delivery calculation
            function getDeliveryHours(order) {
              var timelines = [
                { name: "Basic", ids: ["41290369269835"], hours: 240 },
                { name: "Standard", ids: ["41290369302603", "41274164510795"], hours: 120 },
                { name: "Premium", ids: ["41290369335371"], hours: 30 },
                { name: "Beast", ids: ["41290369368139"], hours: 30 },
                { name: "FAST", ids: ["41274164543563"], hours: 48 },
                { name: "EXPRESS", ids: ["41274164576331"], hours: 24 }
              ];
              var matchedHours = [];
              order.line_items.forEach(function(item) {
                var variantId = String(item.variant_id);
                timelines.forEach(function(timeline) {
                  if(timeline.ids.indexOf(variantId) !== -1) {
                    matchedHours.push(timeline.hours);
                  }
                });
              });
              if(matchedHours.length > 0) {
                return Math.min.apply(null, matchedHours);
              }
              return 240; // default: Basic plan (10 days)
            }
            function getExpectedDelivery(order) {
              var createdAt = new Date(order.created_at);
              var hours = getDeliveryHours(order);
              var deliveryTimestamp = createdAt.getTime() + hours * 60 * 60 * 1000;
              return new Date(deliveryTimestamp).toLocaleDateString("en-IN", {
                timeZone: "Asia/Kolkata",
                year: "numeric",
                month: "short",
                day: "numeric"
              });
            }
          %>
          <% orders.forEach(function(order) { %>
            <tr>
              <!-- Order Number -->
              <td class="col-order"><strong><%= order.name %></strong></td>
              
              <!-- Customer Info -->
              <td class="col-customer">
                <% if (order.customer) { %>
                  <%= order.customer.first_name %> <%= order.customer.last_name %><br>
                  <small><%= order.customer.phone %></small>
                <% } else { %>
                  Guest
                <% } %>
              </td>
              
              <!-- Order Details -->
              <td class="col-details">
                <% order.line_items.forEach(function(item) { %>
                  <div>
                    <strong><%= item.title %></strong> &times; <%= item.quantity %><br>
                    <% if (item.properties && item.properties.length > 0) { %>
                      <% item.properties.forEach(function(prop) { 
                          var propName = prop.name.toLowerCase();
                          var displayValue = prop.value;
                          var shouldHide = false;
                          // For properties from "Form Data", filter confidential info for viewers
                          if (propName.includes('form data')) {
                            if (role === 'viewer') {
                              var lines = displayValue.split('\n');
                              lines = lines.filter(function(line) {
                                var lowerLine = line.toLowerCase();
                                if (
                                  lowerLine.includes('whatsapp') ||
                                  lowerLine.includes('price') ||
                                  lowerLine.includes('song type') ||
                                  lowerLine.includes('uploaded images') ||
                                  lowerLine.includes('selected addons')
                                ) {
                                  return false;
                                }
                                return true;
                              });
                              displayValue = lines.join('\n');
                            }
                          } else {
                            if (role === 'viewer') {
                              if (
                                propName.includes('whatsapp') ||
                                propName.includes('price') ||
                                propName.includes('song type') ||
                                propName.includes('uploaded images') ||
                                propName.includes('selected addons')
                              ) {
                                shouldHide = true;
                              }
                            }
                          }
                      %>
                        <% if (!shouldHide) { %>
                          <small><%= prop.name %>: <%= displayValue %></small><br>
                        <% } %>
                      <% }); %>
                    <% } %>
                  </div>
                  <hr class="my-1">
                <% }); %>
              </td>
              
              <!-- Expected Delivery -->
              <td class="col-delivery">
                <%= getExpectedDelivery(order) %>
              </td>
              
              <!-- Feedback/Changes -->
              <td class="col-feedback">
                <% if (role === 'admin') { %>
                  <input type="text" value="<%= order.note || '' %>" data-order-id="<%= order.id %>" class="feedback-field form-control">
                <% } else { %>
                  <input type="text" value="<%= order.note || '' %>" class="form-control" readonly>
                <% } %>
              </td>
              
              <!-- Comments -->
              <td class="col-comments">
                <%= order.comment || 'N/A' %>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  </div>
  
  <script>
    // For admin users, enable real-time feedback updates on blur.
    if ("<%= role %>" === "admin") {
      document.querySelectorAll('.feedback-field').forEach(function(field) {
        field.addEventListener('blur', function() {
          var orderId = this.getAttribute('data-order-id');
          var feedback = this.value;
          fetch('/update-feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: orderId, feedback: feedback })
          })
          .then(response => response.json())
          .then(data => console.log("Feedback saved:", data))
          .catch(err => console.error("Error saving feedback:", err));
        });
      });
    }
  </script>
</body>
</html>
